# cosmics_xray_correlation

Analysis tools to compare cosmics data with [x-ray wedge alignment data](https://twiki.cern.ch/twiki/bin/viewauth/Atlas/XRayWedgeAlignment). 

To bypass cosmics data having no fixed reference frame, cosmic muon events are retracked using the hits on two fixed layers, and residuals are calculated on a third layer. For tracks falling in a region of interest, the mean of residuals on the third layer is calculated. The mean of residuals will be shifted systematically depending on the relative misalignment of the layer of interest with respect to the two fixed layers, which in turn depends on the absolute misalignment of layers.

X-ray offsets (y_meas - y_beam in the csv files) are used to mimick an "x-ray track" so x-ray residuals can calculated using the offsets on two fixed layers. The x-ray residuals can then be compared to the mean of cosmics residuals around them and calculated with the same reference frame. The program repeats this process for all positions on the quadruplet where x-ray data was taken. Several outputs characterizing the cosmics data and comparing the cosmics and x-ray data are generated.

## Getting cosmics_xray_correlation

```
git clone --recurse-submodules ssh://git@gitlab.cern.ch:7999/McGill-sTGC/cosmics_xray_correlation.git
```
Alternatively, you may clone using https protocol. The flag --recurse-submodules is required since cosmics_xray_correlation takes [tgc_analysis](https://gitlab.cern.ch/McGill-sTGC/tgc_analysis) as a submodule.

## Requirements

cosmics_xray_correlation has the same dependencies as [tgc_analysis](https://gitlab.cern.ch/McGill-sTGC/tgc_analysis), detailed in its README. To setup the appropriate environment on lxplus, run the following:

```
export ATLAS_LOCAL_ROOT_BASE=/cvmfs/atlas.cern.ch/repo/ATLASLocalRootBase
source ${ATLAS_LOCAL_ROOT_BASE}/user/atlasLocalSetup.sh
localSetupROOT 6.14.04-x86_64-slc6-gcc62-opt
export ALRB_rootVersion=6.14.04-x86_64-slc6-gcc62-opt
```
## Compilation

All modules and submodules have their own Makefile. So to compile, simply type "make".

## Usage

First, a custom clustering algorithm was used to fit the PDO distribution of muon hits on each layer, stored in the directory, ReClustering. The input to ReClustering is a list of CosmicsAnalysis.root files from which the tracks TTrees are combined and all events therein processed. 

ReClustering usage:

./ReClustering [-o outdirectory] [--tag prefix] [--dnlconfig dnlconfigfile] CosmicsAnalysis.root [CosmicsAnalysis2.root...]

The default output directory it ./out. The prefix is prepended to any output files ReClustering produces (default none). The --dnlconfig flag will be discussed momentarily. The input is a CosmicsAnalysis.root file, which is generated by [CosmicsAnalysis](https://gitlab.cern.ch/McGill-sTGC/tgc_analysis/-/tree/master/CosmicsAnalysis). The data from separate CosmicsAnalysis files are analyzed in sequence.

The user may decide to apply a differential non linearity correction to the recalculated cluster positions, and the amplitude of those DNL corrections is specified in a DNL configuration text file.

The DNL correction takes the form:
$$ \delta*y_{dnl} = a_{m}*sin(2*\pi*y_{rel})$$
as defined in [eqn. 5.8 of Benoit Lefebvre's thesis](https://cds.cern.ch/record/2633639?ln=en).

If no DNL configuration is provided, the default is not to apply a DNL correction. The DNL configuration file has the format:
[cluster multiplicity] [amplitude in millimeters], 
where multiplicity is the number of strips with hits above threshold or neighbour triggered on a particular layer for a particular event. If you want a DNL correction to be applied to all multiplicities or a default amplitude value for clusters with multiplicities without a custom amplitude defined, include an amplitude entry for multiplicity zero as the first line of the configuration file.

The output root file of ReClustering is the input of cosmics_xray_correlation.

cosmics_xray_correlation usage:

Usage: ./CosmicsXRayCorrelation input_reclustering.root QUADNAME input_reclustering.root QUADNAME input_xray.csv outpath/ tag_

input_reclustering.root is the output of ReClustering. 
QUADNAME specifies the quadruplet module, with format e.g. QL2P06.
input_x_ray.csv contains the production x-ray measurements (stored in: lxplus.cern.ch:/eos/atlas/atlascerngroupdisk/det-nsw-stgc/xray_alignment_test/result) generated by [WedgeAlignmentXRay-Production](https://gitlab.cern.ch/blefebvr/WedgeAlignmentXRay-Production). 
outpath specifies the outpath directory.
tag_ specifies the prefix with which to name the output files.

## Analysis

All plots generated by cosmics_xray_correlation are output to tag_cosmics_xray_correlation.root.

All units are in millimeters unless otherwise specified.

